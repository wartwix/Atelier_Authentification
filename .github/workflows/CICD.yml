name: Industrialisation continue sur le serveur Alwaysdata

on:
  push:
    branches: [ "main" ] # V√©rifiez si votre branche s'appelle 'main' ou 'master'

jobs:
  Deploy:
    runs-on: ubuntu-latest
    steps:
      - name: D√©ploiement et Configuration S√©curit√©
        uses: appleboy/ssh-action@master
        with:
          host: "ssh-${{ secrets.USERNAME }}.alwaysdata.net"
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          
          # La variable HTPASSWD_CONTENT est inject√©e directement
          # dans le script par l'interpolation ${{ secrets.HTPASSWD_CONTENT }}
          script: |
            # 1. D√©finition des variables
            REPO_URL="https://github.com/${{ github.repository }}.git"
            TARGET_DIR="$HOME/www"
            CLONE_DIR="$HOME/clone_temp"

            # 2. Nettoyage et Clonage propre
            echo "üóëÔ∏è Nettoyage et clonage du d√©p√¥t..."
            rm -rf $CLONE_DIR
            git clone $REPO_URL $CLONE_DIR

            # 3. Synchronisation (Copie des fichiers vers www)
            mkdir -p $TARGET_DIR
            
            if [ -d "$CLONE_DIR" ]; then
              # On copie le contenu du clone vers www
              rsync -r --delete --exclude '.git' $CLONE_DIR/ $TARGET_DIR/
              rm -rf $CLONE_DIR
              echo "‚úÖ Site mis √† jour avec succ√®s."
            else
              echo "‚ùå Erreur : Le clonage a √©chou√©."
              exit 1
            fi

            # --- PARTIE EXERCICE 3 : GESTION DU .HTPASSWD ---
            
            echo "üîí Configuration de la s√©curit√© (Basic Auth)..."
            
            # Cr√©ation du dossier sp√©cifique atelier1 (si non copi√© par rsync)
            mkdir -p $TARGET_DIR/atelier1
            
            # Cr√©ation du fichier .htpasswd √† partir du SECRET GitHub
            # L'interpolation du Secret GitHub ${{ secrets.HTPASSWD_CONTENT }}
            # fonctionne ici car elle est g√©r√©e par l'action ssh-action.
            echo "${{ secrets.HTPASSWD_CONTENT }}" > $TARGET_DIR/atelier1/.htpasswd
            
            # 4. Configuration .htaccess (pour l'Exercice 2 et 3)
            # Ajout des directives de s√©curit√© pour cacher .htpasswd
            HTACCESS_CONTENT="AuthName \"Acces protege\""$'\n'
            HTACCESS_CONTENT+="AuthType Basic"$'\n'
            HTACCESS_CONTENT+="AuthUserFile $TARGET_DIR/atelier1/.htpasswd"$'\n'
            HTACCESS_CONTENT+="Require valid-user"$'\n'
            HTACCESS_CONTENT+="<Files \".ht*\">"$'\n'
            HTACCESS_CONTENT+="Require all denied"$'\n'
            HTACCESS_CONTENT+="</Files>"
            
            # √âcriture du .htaccess dans le dossier prot√©g√©
            echo "$HTACCESS_CONTENT" > $TARGET_DIR/atelier1/.htaccess
            echo "‚úÖ Fichier .htaccess configur√© et s√©curis√©."
