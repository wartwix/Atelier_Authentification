name: Industrialisation continue sur le serveur Alwaysdata

on:
  push:
    branches: [ "main" ]

jobs:
  Deploy:
    runs-on: ubuntu-latest
    steps:
      - name: D√©ploiement et Configuration S√©curit√©
        uses: appleboy/ssh-action@master
        env:
          # On r√©cup√®re le mot de passe en clair (admin) depuis les secrets
          PASS_CLAIR: ${{ secrets.HTPASSWD_CONTENT }}
        with:
          host: "ssh-${{ secrets.USERNAME }}.alwaysdata.net"
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          # On passe la variable d'environnement au script
          envs: PASS_CLAIR
          script: |
            # --- CONFIGURATION ---
            REPO_URL="https://github.com/${{ github.repository }}.git"
            TARGET_DIR="$HOME/www"
            CLONE_DIR="$HOME/clone_temp"

            # --- 1. CLONAGE DU SITE ---
            rm -rf $CLONE_DIR
            git clone $REPO_URL $CLONE_DIR

            # --- 2. DEPLOIEMENT ---
            mkdir -p $TARGET_DIR
            if [ -d "$CLONE_DIR" ]; then
              rsync -r --delete --exclude '.git' $CLONE_DIR/ $TARGET_DIR/
              rm -rf $CLONE_DIR
              echo "‚úÖ Site mis √† jour."
            else
              echo "‚ùå Erreur de clonage."
              exit 1
            fi

            # --- 3. SECURITE (Nouvelle m√©thode) ---
            echo "üîí G√©n√©ration du fichier mot de passe..."
           
            mkdir -p $TARGET_DIR/atelier1
           
            # Suppression de l'ancien fichier pour √©viter les conflits
            rm -f $TARGET_DIR/atelier1/.htpasswd
           
            # UTILISATION DE LA COMMANDE LINUX NATIVE
            # -c : cr√©er un nouveau fichier
            # -b : mode batch (on donne le mdp direct)
            # Syntaxe : htpasswd -cb [fichier] [user] [password]
            htpasswd -cb $TARGET_DIR/atelier1/.htpasswd admin $PASS_CLAIR
           
            # V√©rification finale
            if [ -f "$TARGET_DIR/atelier1/.htpasswd" ]; then
                echo "‚úÖ Fichier .htpasswd g√©n√©r√© avec succ√®s."
                # Affiche les permissions pour √™tre s√ªr (optionnel)
                ls -l $TARGET_DIR/atelier1/.htpasswd
            else
                echo "‚ùå Echec de la cr√©ation du fichier mot de passe."
                exit 1
            fi
