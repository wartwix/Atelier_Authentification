name: Industrialisation continue sur le serveur Alwaysdata

on:
  push:
    branches: [ "main" ] # V√©rifiez si votre branche s'appelle 'main' ou 'master'

jobs:
  # Note : J'ai fusionn√© la connexion et la copie pour plus d'efficacit√©,
  # car le premier job "Connexion" ne faisait rien de persistant.
  Deploy:
    runs-on: ubuntu-latest
    steps:
      - name: D√©ploiement et Configuration S√©curit√©
        uses: appleboy/ssh-action@master
        with:
          host: "ssh-${{ secrets.USERNAME }}.alwaysdata.net"
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          # On rend le secret accessible dans le script via une variable d'environnement
          envs: HTPASSWD_CONTENT
          script: |
            # 1. D√©finition des variables
            REPO_URL="https://github.com/${{ github.repository }}.git"
            TARGET_DIR="$HOME/www"
            CLONE_DIR="$HOME/clone_temp"

            # 2. Nettoyage et Clonage propre
            rm -rf $CLONE_DIR
            git clone $REPO_URL $CLONE_DIR

            # 3. Synchronisation (Copie des fichiers vers www)
            # On s'assure que le dossier www existe
            mkdir -p $TARGET_DIR
           
            if [ -d "$CLONE_DIR" ]; then
              # On copie le contenu du clone vers www
              rsync -r --delete --exclude '.git' $CLONE_DIR/ $TARGET_DIR/
              rm -rf $CLONE_DIR
              echo "‚úÖ Site mis √† jour avec succ√®s."
            else
              echo "‚ùå Erreur : Le clonage a √©chou√©."
              exit 1
            fi

            # --- PARTIE EXERCICE 3 : GESTION DU .HTPASSWD ---
           
            echo "üîí Configuration de la s√©curit√© (Basic Auth)..."
           
            # Cr√©ation du dossier sp√©cifique atelier1
            mkdir -p $TARGET_DIR/atelier1
           
            # Cr√©ation du fichier .htpasswd √† partir du SECRET GitHub
            # La variable $HTPASSWD_CONTENT est inject√©e automatiquement par l'action
            echo "${{ secrets.HTPASSWD_CONTENT }}" > $TARGET_DIR/atelier1/.htpasswd
           
            # V√©rification (optionnelle)
            if [ -f "$TARGET_DIR/atelier1/.htpasswd" ]; then
                echo "‚úÖ Fichier .htpasswd cr√©√© avec succ√®s."
            else
                echo "‚ùå Erreur lors de la cr√©ation du fichier .htpasswd"
                exit 1
            fi
        env:
          # C'est ici qu'on lie le Secret GitHub √† la variable utilis√©e dans le script ci-dessus
          HTPASSWD_CONTENT: ${{ secrets.HTPASSWD_CONTENT }}
